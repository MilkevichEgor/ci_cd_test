image: docker:latest
stages:
  - deploy
  
deploy:
  stage: deploy    
  # before_script:
  #   - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
  #   - eval $(ssh-agent -s)
  #   - chmod 400 "$SSH_PRIVATE_KEY"
  #   - ssh-add "$SSH_PRIVATE_KEY"
  #   - mkdir -p ~/.ssh
  #   - chmod 700 ~/.ssh
  script:
    - cat <<< $SSH_PRIVATE_KEY > ssh_key
    - chmod 400 ssh_key
    - ssh -i ssh_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "cd /home/fusion/project_em/books-store; echo 'test' > some.txt;"
   # - ssh -i ssh_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "cd /home/fusion/project_em/books-store; git pull"
    - ssh -i ssh_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "cd /home/fusion/project_em/books-store; docker compose up -d"
